<!DOCTYPE html>
<html>
<head>
  <title>Mi Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="/socket.io/socket.io.js"></script>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: Arial;
      height: 100dvh; /* dynamic viewport */
      display: flex;
      background: #e5ddd5;
      overflow: hidden;
    }

    .users {
      width: 260px;
      background: #fff;
      border-right: 1px solid #ddd;
      padding: 10px;
      overflow-y: auto;
    }

    .user, .group {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }

    .group { font-weight: bold; background: #f0f0f0; }
    .online { color: green; }
    .offline { color: gray; }

    .chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #efeae2;
      position: relative;
    }

    .header {
      padding: 12px;
      background: #075e54;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }

    #backBtn {
      display: none;
      cursor: pointer;
      font-size: 18px;
    }

    .typing {
      font-size: 12px;
      padding: 4px 12px;
      height: 18px;
      flex-shrink: 0;
    }

    .messages {
      flex: 1;
      padding: 12px;
      overflow-y: auto;
      padding-bottom: 80px; /* space for input */
    }

    .msg {
      max-width: 70%;
      margin-bottom: 8px;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 14px;
    }

    .me { background: #dcf8c6; margin-left: auto; }
    .them { background: #fff; }

    .meta {
      font-size: 11px;
      opacity: .6;
      text-align: right;
    }

    /* INPUT FIX */
    .input {
      position: fixed;
      bottom: env(safe-area-inset-bottom);
      left: 0;
      right: 0;
      display: flex;
      padding: 10px;
      background: #f0f0f0;
      gap: 8px;
      z-index: 100;
    }

    .input input {
      flex: 1;
      padding: 12px;
      border-radius: 20px;
      border: 1px solid #ccc;
      font-size: 15px;
    }

    .input button {
      padding: 12px 18px;
      background: #075e54;
      color: #fff;
      border: none;
      border-radius: 20px;
      font-size: 14px;
    }

    /* MOBILE NAV */
    @media (max-width: 768px) {
      body { flex-direction: column; }

      .users {
        width: 100%;
        height: 100dvh;
      }

      .chat {
        display: none;
        height: 100dvh;
      }

      body.chat-open .users { display: none; }
      body.chat-open .chat { display: flex; }

      #backBtn { display: inline; }
    }
  </style>
</head>

<body>

<div class="users">
  <div class="group" onclick="selectGroup()">üåê Group Chat</div>
  <hr>
  <div id="userList"></div>
</div>

<div class="chat">
  <div class="header">
    <span id="backBtn" onclick="goBack()">‚Üê</span>
    <span id="chatTitle">Group Chat</span>
  </div>

  <div class="typing" id="typing"></div>
  <div class="messages" id="messages"></div>

  <div class="input">
    <input id="msg" placeholder="Type a message..." />
    <button onclick="send()">Send</button>
  </div>
</div>

<script>
const socket = io();
const me = prompt("Enter your name");
let mode = "group";
let selectedUser = null;
const messages = { group: [] };
const msgInput = document.getElementById("msg");
const typingDiv = document.getElementById("typing");
let typingTimer;

socket.emit("join", me);

/* USER LIST */
socket.on("user-list", users => {
  const ul = document.getElementById("userList");
  ul.innerHTML = "";
  for (const u in users) {
    if (u === me) continue;
    const div = document.createElement("div");
    div.className = "user " + users[u];
    div.innerText = `${u} (${users[u]})`;
    div.onclick = () => selectUser(u);
    ul.appendChild(div);
  }
});

/* SELECT CHAT */
function selectGroup() {
  mode = "group";
  selectedUser = null;
  document.getElementById("chatTitle").innerText = "Group Chat";
  document.body.classList.add("chat-open");
  messagesDiv().innerHTML = "";
  messages.group.forEach(renderMessage);
}

function selectUser(user) {
  mode = "private";
  selectedUser = user;
  document.getElementById("chatTitle").innerText = user;
  document.body.classList.add("chat-open");
  messagesDiv().innerHTML = "";
  messages[user] = messages[user] || [];
  messages[user].forEach(renderMessage);
}

function goBack() {
  document.body.classList.remove("chat-open");
}

/* SEND */
function send() {
  const text = msgInput.value.trim();
  if (!text) return;

  const message = {
    from: me,
    text,
    time: new Date().toLocaleTimeString(),
    msgId: Date.now() + me,
    status: "sent"
  };

  if (mode === "group") {
    messages.group.push(message);
    renderMessage(message);
    socket.emit("group-message", message);
  } else {
    messages[selectedUser].push(message);
    renderMessage(message);
    socket.emit("private-message", { to: selectedUser, message });
  }

  msgInput.value = "";
}

/* RECEIVE */
socket.on("group-message", m => {
  messages.group.push(m);
  if (mode === "group") renderMessage(m);
});

socket.on("private-message", m => {
  m.status = "delivered";
  messages[m.from] = messages[m.from] || [];
  messages[m.from].push(m);
  if (mode === "private" && selectedUser === m.from) {
    renderMessage(m);
    socket.emit("seen", { to: m.from, msgId: m.msgId });
    m.status = "seen";
  }
});

/* TYPING */
msgInput.addEventListener("input", emitTyping);
msgInput.addEventListener("keydown", emitTyping);

function emitTyping() {
  if (!document.body.classList.contains("chat-open")) return;
  if (mode === "group") socket.emit("group-typing");
  if (mode === "private" && selectedUser)
    socket.emit("private-typing", { to: selectedUser });
}

socket.on("group-typing", showTyping);
socket.on("private-typing", showTyping);

function showTyping(user) {
  typingDiv.innerText = `${user} is typing...`;
  clearTimeout(typingTimer);
  typingTimer = setTimeout(() => typingDiv.innerText = "", 1200);
}

/* HELPERS */
function renderMessage(m) {
  const div = document.createElement("div");
  div.className = `msg ${m.from === me ? "me" : "them"}`;
  div.innerHTML = `
    ${m.text}
    <div class="meta">${m.time}</div>
  `;
  messagesDiv().appendChild(div);
  messagesDiv().scrollTop = messagesDiv().scrollHeight;
}

function messagesDiv() {
  return document.getElementById("messages");
}
</script>

</body>
</html>
